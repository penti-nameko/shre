# apps/server/server.py

from flask import Flask, jsonify, request, abort
from datetime import datetime
import os

# Flaskã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
app = Flask(__name__)

# ----------------------------------------------------------------------
# ğŸ“ ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆé€šå¸¸ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ï¼‰
# ----------------------------------------------------------------------
# ã“ã®ãƒªã‚¹ãƒˆãŒã€Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€ã®å½¹å‰²ã‚’æœãŸã—ã¾ã™
items = [
    {"id": 1, "name": "Item A", "description": "æœ€åˆã®ã‚µãƒ³ãƒ—ãƒ«ã‚¢ã‚¤ãƒ†ãƒ ã§ã™ã€‚", "created_at": "2024-01-15T10:00:00Z"},
    {"id": 2, "name": "Item B", "description": "2ç•ªç›®ã®ã‚µãƒ³ãƒ—ãƒ«ã‚¢ã‚¤ãƒ†ãƒ ã§ã™ã€‚", "created_at": "2024-01-16T11:00:00Z"},
]
# æ¬¡ã«ä½œæˆã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã«å‰²ã‚Šå½“ã¦ã‚‹ID
next_id = 3

# ----------------------------------------------------------------------
# 1. ã™ã¹ã¦ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—ã™ã‚‹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° (GET /api/items)
# ----------------------------------------------------------------------
@app.route('/api/items', methods=['GET'])
def get_items():
    """å…¨ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒªã‚¹ãƒˆã‚’è¿”ã—ã¾ã™ã€‚"""
    # å®Ÿéš›ã«ã¯ã“ã“ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™
    return jsonify(items)

# ----------------------------------------------------------------------
# 2. ç‰¹å®šã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—ã™ã‚‹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° (GET /api/items/<id>)
# ----------------------------------------------------------------------
@app.route('/api/items/<int:item_id>', methods=['GET'])
def get_item(item_id):
    """ãƒ«ãƒ¼ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æŒ‡å®šã•ã‚ŒãŸIDã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿”ã—ã¾ã™ã€‚"""
    
    # ãƒªã‚¹ãƒˆå†…åŒ…è¡¨è¨˜ã¨ next() ã‚’ä½¿ç”¨ã—ã¦ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¤œç´¢
    item = next((i for i in items if i["id"] == item_id), None)
    
    if item is None:
        # ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ 404 Not Found ã‚’è¿”ã™
        # abort() ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€å¾Œè¿°ã® errorhandler ã«å‡¦ç†ãŒæ¸¡ã‚Šã¾ã™
        abort(404, description=f"Item with ID {item_id} not found")
    
    return jsonify(item)

# ----------------------------------------------------------------------
# 3. æ–°è¦ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆã™ã‚‹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° (POST /api/items)
# ----------------------------------------------------------------------
@app.route('/api/items', methods=['POST'])
def create_item():
    """ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®JSONãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ–°è¦ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆã—ã¾ã™ã€‚"""
    
    # ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®JSONãƒœãƒ‡ã‚£ã‚’å–å¾—
    request_data = request.get_json()
    
    # 'name' ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå¿…é ˆã§ã‚ã‚‹ã‹ã‚’ç¢ºèª
    if not request_data or 'name' not in request_data:
        # å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãªã„å ´åˆã¯ 400 Bad Request ã‚’è¿”ã™
        abort(400, description="Missing 'name' field in request body or invalid JSON format")

    global next_id
    
    # æ–°è¦ã‚¢ã‚¤ãƒ†ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã€IDã‚’å‰²ã‚Šå½“ã¦
    new_item = {
        "id": next_id,
        "name": request_data['name'],
        # descriptionã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã€æä¾›ã•ã‚Œã¦ã„ãªã‘ã‚Œã°ç©ºæ–‡å­—åˆ—
        "description": request_data.get('description', ''),
        "created_at": datetime.now().isoformat() + 'Z'
    }

    # ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ï¼ˆãƒªã‚¹ãƒˆï¼‰ã«è¿½åŠ 
    items.append(new_item)
    next_id += 1

    # 201 Created ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã¨å…±ã«æ–°è¦ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿”ã™
    return jsonify(new_item), 201

# ----------------------------------------------------------------------
# 4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å®šç¾©
# ----------------------------------------------------------------------

# 404 (Not Found) ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®å‡¦ç†
@app.errorhandler(404)
def not_found(error):
    return jsonify({
        'error': 'Not Found',
        'message': error.description
    }), 404

# 400 (Bad Request) ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®å‡¦ç†
@app.errorhandler(400)
def bad_request(error):
    return jsonify({
        'error': 'Bad Request',
        'message': error.description
    }), 400

# ----------------------------------------------------------------------
# ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•
# ----------------------------------------------------------------------
if __name__ == '__main__':
    # ç’°å¢ƒå¤‰æ•°PORTãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°5000
    port = int(os.environ.get('PORT', 5000))
    # host='0.0.0.0' ã¯å¤–éƒ¨ã‹ã‚‰ã®æ¥ç¶šã‚’è¨±å¯ã™ã‚‹ãŸã‚ã«ã‚ˆãä½¿ã‚ã‚Œã¾ã™
    # debug=True ã¯é–‹ç™ºä¸­ã«ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ãŸéš›ã«è‡ªå‹•ã§å†èµ·å‹•ã™ã‚‹ãŸã‚ã«ä¾¿åˆ©ã§ã™
    app.run(host='0.0.0.0', port=port, debug=True)